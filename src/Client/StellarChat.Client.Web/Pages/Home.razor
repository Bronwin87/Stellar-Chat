@page "/"
@page "/c/{ChatId:guid}"

@inject IConfiguration _configuration
@inject ChatState _chatState
@inject IChatService _chatService
@inject IActionService _actionService
@inject NavigationManager _navigationManager
@inject IJSRuntime JS
@inject TimeProvider _clock
@implements IAsyncDisposable

<PageTitle>Home</PageTitle>

<div class="h-100">
    <div class="w-100 mt-4 mx-auto" style="max-width: 960px;">
        <div @ref="ChatMessagesDiv" id="chat-messages" class="overflow-auto" style="height: calc(100vh - 295px);">
            @if (_chatState.ChatId == Guid.Empty)
            {
                <div style="height: 100%; width: 100%; display: flex; justify-content: center;">
                    <NewChatPreview AssistantName="@_chatState.SelectedAssistant?.Name" UserName="@_chatState.UserName" AssistantAvatar="@_chatState.SelectedAssistant?.AvatarUrl" />
                </div>
            }
            else
            {
                @foreach (var chatMessage in ChatMessages)
                {
                    <ChatMessage Message=@chatMessage />
                }
            }
        </div>
    </div>
    <div class="mt-2 fixed-bottom w-auto">
        <PromptInput OnSend="@SendMessage" />
    </div>
</div>

@code
{
    [Parameter] public Guid? ChatId { get; set; }

    private List<ChatMessageResponse> ChatMessages { get; set; } = new();
    private ElementReference ChatMessagesDiv { get; set; } = new();
    private ChatMessageResponse LatestBotMessage { get; set; } = new();
    private StringBuilder _textStreaming = new();
    private HubConnection? _hubConnection;

    private const string ReceiveMessageUpdateServerCall = "ReceiveChatMessageChunk";
    private const string AddClientToGroupServerCall = "AddClientToGroupAsync";
    private string HubUrl => $"{_configuration["api:api_url"]}/hub";

    protected override async Task OnInitializedAsync()
    {
        _chatState.ChatIdChanged += async () => await LoadChatHistory();
        _chatState.SelectedAssistantChanged += StateHasChanged;
        _chatState.SelectedModelChanged += StateHasChanged;
        _chatState.UserNameChanged += StateHasChanged;
        _chatState.ActionIdChanged += StateHasChanged;

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(HubUrl)
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string>(ReceiveMessageUpdateServerCall, async (message) =>
        {
            _textStreaming.Append(message);
            LatestBotMessage.Content = _textStreaming.ToString();

            await InvokeAsync(StateHasChanged);
            await JS.InvokeVoidAsync("scrollToBottom", ChatMessagesDiv);

            Console.WriteLine($"ReceiveChatMessageChunk: {message}");
        });

        Console.WriteLine("Starting connection...");

        await _hubConnection.StartAsync();

        Console.WriteLine($"Connection state: {_hubConnection.State}");

        if (ChatId.HasValue && ChatId != Guid.Empty)
        {
            _chatState.SetChatId(ChatId.Value);
            await LoadChatHistory();
        }
    }

    private async Task LoadChatHistory()
    {
        var chatId = _chatState.ChatId;

        if (chatId != Guid.Empty)
        {
            var response = await _chatService.GetChatMessagesByChatId(_chatState.ChatId);
            ChatMessages = response.Items.ToList();

            await InvokeAsync(StateHasChanged);
            await JS.InvokeVoidAsync("scrollToBottom", ChatMessagesDiv);
        }
    }

    private async Task SendMessage(string message)
    {
        var chatId = _chatState.ChatId;
        var actionId = _chatState.ActionId;
        var assistantId = _chatState.SelectedAssistant!.Id;

        if (!string.IsNullOrWhiteSpace(message))
        {
            if (chatId == Guid.Empty)
            {
                var newChatId = await _chatService.CreateChatSession(assistantId, "New Chat");

                chatId = newChatId;
                _chatState.SetIsNewChatPending(true);
                _chatState.SetChatId(newChatId);

                await LoadChatHistory();
                _navigationManager.NavigateTo($"/c/{chatId}");
            }

            var userMessage = CreateUserMessage(chatId, message);
            LatestBotMessage = CreateBotMessage(chatId, string.Empty);

            ChatMessages.Add(userMessage);
            await JS.InvokeVoidAsync("scrollToBottom", ChatMessagesDiv);

            ChatMessages.Add(LatestBotMessage);
            await JS.InvokeVoidAsync("scrollToBottom", ChatMessagesDiv);

            if (actionId != Guid.Empty && chatId != Guid.Empty)
            {
                await _actionService.ExecuteAction(actionId, chatId, message);
                _textStreaming.Clear();
                return;
            }

            await _chatService.SendMessage(chatId, message, "", _chatState.SelectedModel);
            _textStreaming.Clear();
        }
    }



    private ChatMessageResponse CreateUserMessage(Guid chatId, string message, ChatMessageType messageType = ChatMessageType.Message)
    {
        var now = _clock.GetLocalNow();

        var userMessage = new ChatMessageResponse
            {
                Id = Guid.NewGuid(),
                ChatId = chatId,
                Type = messageType,
                Author = "user",
                Content = message,
                Timestamp = now
            };

        return userMessage;
    }

    private ChatMessageResponse CreateBotMessage(Guid chatId, string message, ChatMessageType messageType = ChatMessageType.Message)
    {
        var now = _clock.GetLocalNow();

        var chatMessage = new ChatMessageResponse
            {
                Id = Guid.NewGuid(),
                ChatId = chatId,
                Type = messageType,
                Author = "bot",
                Content = message,
                Timestamp = now
            };

        return chatMessage;
    }

    public async ValueTask DisposeAsync()
    {
        _chatState.ChatIdChanged -= async () => await LoadChatHistory();
        _chatState.SelectedAssistantChanged -= StateHasChanged;
        _chatState.SelectedModelChanged -= StateHasChanged;
        _chatState.UserNameChanged -= StateHasChanged;
        _chatState.ActionIdChanged -= StateHasChanged;

        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
